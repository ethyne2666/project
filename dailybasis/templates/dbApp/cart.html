{% extends "dbApp/base.html" %}
{% load static %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="cart-page-container">
    <div class="shopping-cart-section">
        <h2 class="cart-title">Shopping Cart</h2>
        {% if cart_items %}
            <div class="cart-items-list">
                {% for item in cart_items %}
                <div class="cart-item" data-product-id="{{ item.product_id }}">
                    <img src="{{ item.image }}" alt="{{ item.name }}" class="cart-item-image">
                    <div class="cart-item-details">
                        <span class="cart-item-name">{{ item.name }}</span>
                        <span class="cart-item-price">₹{{ item.price }}</span>
                    </div>
                    <div class="cart-item-quantity-control">
                        <button class="btn-cart-quantity minus-btn">-</button>
                        <span class="quantity-display" data-product-id="{{ item.product_id }}">{{ item.quantity }}</span>
                        <button class="btn-cart-quantity plus-btn">+</button>
                    </div>
                    <span class="cart-item-total-price">₹{{ item.total_price|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-cart-message">Your cart is empty.</p>
        {% endif %}
    </div>

    <div class="order-summary-section">
        <h2 class="summary-title">Order Summary</h2>
        <div class="summary-line">
            <span>Subtotal</span>
            <span id="subtotal-price">₹{{ subtotal|floatformat:2 }}</span>
        </div>
        <div class="summary-line">
            <span>Delivery Fee</span>
            <span id="delivery-price">₹{{ delivery_fee|floatformat:2 }}</span>
        </div>
        <hr>
        <div class="summary-line total">
            <span>Total</span>
            <span id="total-price">₹{{ total|floatformat:2 }}</span>
        </div>
        <button class="btn-checkout">Proceed to Checkout</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartItemsList = document.querySelector('.cart-items-list');
        const subtotalPriceElement = document.getElementById('subtotal-price');
        const totalPriceElement = document.getElementById('total-price');
        const deliveryFee = parseFloat(document.getElementById('delivery-price').textContent.replace('₹', ''));

        cartItemsList.addEventListener('click', function(e) {
            const target = e.target;
            let currentQuantityElement;
            let currentQuantity;

            if (target.classList.contains('plus-btn') || target.classList.contains('minus-btn')) {
                currentQuantityElement = target.parentElement.querySelector('.quantity-display');
                currentQuantity = parseInt(currentQuantityElement.textContent);
            }

            if (target.classList.contains('plus-btn')) {
                currentQuantity++;
                currentQuantityElement.textContent = currentQuantity;
            } else if (target.classList.contains('minus-btn')) {
                if (currentQuantity > 1) {
                    currentQuantity--;
                    currentQuantityElement.textContent = currentQuantity;
                } else {
                    // ✅ Remove from backend session also
                    const cartItem = target.closest('.cart-item');
                    const productId = cartItem.dataset.productId;

                    fetch(`/remove-from-cart/${productId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            cartItem.remove();
                            updateSummary();
                        }
                    });
                }
            }
            updateSummary();
        });

        function updateSummary() {
            let subtotal = 0;
            const items = document.querySelectorAll('.cart-item');

            if (items.length === 0) {
                cartItemsList.innerHTML = '<p class="empty-cart-message">Your cart is empty.</p>';
                subtotalPriceElement.textContent = '₹0.00';
                totalPriceElement.textContent = `₹${deliveryFee.toFixed(2)}`;
                return;
            }

            items.forEach(item => {
                const price = parseFloat(item.querySelector('.cart-item-price').textContent.replace('₹', ''));
                const quantity = parseInt(item.querySelector('.quantity-display').textContent);
                subtotal += price * quantity;
                item.querySelector('.cart-item-total-price').textContent = `₹${(price * quantity).toFixed(2)}`;
            });

            subtotalPriceElement.textContent = `₹${subtotal.toFixed(2)}`;
            totalPriceElement.textContent = `₹${(subtotal + deliveryFee).toFixed(2)}`;
        }
    });
</script>
{% endblock %}
